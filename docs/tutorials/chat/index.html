<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:400,600|Source+Code+Pro&display=swap"
      rel="stylesheet">
    <link rel="stylesheet" href="/style.min.css">
  
    <title>Server.js - Tutorials</title>
    <meta name="description" content="A library to easily create a modern Node.js server. Handles HTTP, Websockets and all the small details." />
    <link rel="icon" type="image/png" href="/img/logo.png"/>
  
    <!-- Twitter -->
    <meta name="twitter:title" content="Server.js - Tutorials" />
    <meta name="twitter:description" content="A library to easily create a modern Node.js server. Handles HTTP, Websockets and all the small details." />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://node-server.com/" />
    <meta name="twitter:image" content="https://node-server.com/img/hero.png">
  
    <!-- Facebook & others -->
    <meta property="og:title" content="Server.js - Tutorials" />
    <meta property="og:description" content="A library to easily create a modern Node.js server. Handles HTTP, Websockets and all the small details." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://node-server.com/" />
    <meta property="og:image" content="https://node-server.com/img/hero.png" />
  </head>
  <body>
    <nav>
      <a href="/" class="brand">
        <img class="logo" src="/img/logo.svg" alt="">
        <span>Server.js</span>
      </a>
    
      <input id="bmenub" type="checkbox" class="show">
      <label for="bmenub" class="burger">menu</label>
    
      <div class="menu">
        <a href="/about">About</a>
        <a href="/documentation">Documentation</a>
        <!-- <a href="/screencasts">Screencasts</a> -->
        <a href="/tutorials">Tutorials</a>
        <a href="https://github.com/franciscop/server">Github</a>
      </div>
    </nav>
    <main>
      <div class="flex">
        <div class="thirty">
          <aside>
            <div class="scroller">
              <form class="search">
                <input name="search" placeholder="Search Tutorials" />
                <div class="results"></div>
              </form>
                <section>
                  <h3>
                    <div class="more"><img src="/img/plus.svg" /></div>
                    <a href="/tutorials/">Getting started</a>
                  </h3>
                  <div class="submenu">
                      <div>
                        <a href="/tutorials/#install-node-js">
                          <img src="/img/file.svg" /><span>Install Node.js<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/#create-your-project">
                          <img src="/img/file.svg" /><span>Create your project<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/#initialize-git-and-npm">
                          <img src="/img/file.svg" /><span>Initialize git and npm<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/#build-your-project">
                          <img src="/img/file.svg" /><span>Build your project<span>
                        </a>
                      </div>
                  </div>
                </section>
                <section>
                  <h3>
                    <div class="more"><img src="/img/plus.svg" /></div>
                    <a href="/tutorials/server-production/">Server in production</a>
                  </h3>
                  <div class="submenu">
                      <div>
                        <a href="/tutorials/server-production/#set-a-secret">
                          <img src="/img/file.svg" /><span>Set a secret<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/server-production/#session-storage">
                          <img src="/img/file.svg" /><span>Session Storage<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/server-production/#correct-environment">
                          <img src="/img/file.svg" /><span>Correct environment<span>
                        </a>
                      </div>
                  </div>
                </section>
                <section>
                  <h3>
                    <div class="more"><img src="/img/plus.svg" /></div>
                    <a href="/tutorials/spreadsheet/">Spreadsheet database</a>
                  </h3>
                  <div class="submenu">
                      <div>
                        <a href="/tutorials/spreadsheet/#create-a-spreadsheet">
                          <img src="/img/file.svg" /><span>Create a spreadsheet<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/spreadsheet/#installation">
                          <img src="/img/file.svg" /><span>Installation<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/spreadsheet/#back-end-with-server-js">
                          <img src="/img/file.svg" /><span>Back-end with server.js<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/spreadsheet/#front-end">
                          <img src="/img/file.svg" /><span>Front-end<span>
                        </a>
                      </div>
                  </div>
                </section>
                <section>
                  <h3>
                    <div class="more"><img src="/img/plus.svg" /></div>
                    <a href="/tutorials/todo/">Todo</a>
                  </h3>
                  <div class="submenu">
                      <div>
                        <a href="/tutorials/todo/#install-dependencies">
                          <img src="/img/file.svg" /><span>Install dependencies<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/todo/#code-organization">
                          <img src="/img/file.svg" /><span>Code organization<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/todo/#rest-api">
                          <img src="/img/file.svg" /><span>REST API<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/todo/#database">
                          <img src="/img/file.svg" /><span>Database<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/todo/#todos-logic">
                          <img src="/img/file.svg" /><span>Todos logic<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/todo/#testing">
                          <img src="/img/file.svg" /><span>Testing<span>
                        </a>
                      </div>
                  </div>
                </section>
                <section>
                  <h3>
                    <div class="more"><img src="/img/plus.svg" /></div>
                    <a href="/tutorials/chat/">Real-time Chat</a>
                  </h3>
                  <div class="submenu">
                      <div>
                        <a href="/tutorials/chat/#user-interface">
                          <img src="/img/file.svg" /><span>User Interface<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/chat/#choose-a-username">
                          <img src="/img/file.svg" /><span>Choose a username<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/chat/#sending-messages">
                          <img src="/img/file.svg" /><span>Sending messages<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/chat/#server-handling">
                          <img src="/img/file.svg" /><span>Server handling<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/chat/#user-x-joined">
                          <img src="/img/file.svg" /><span>User X joined<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/chat/#upload-to-heroku">
                          <img src="/img/file.svg" /><span>Upload to Heroku<span>
                        </a>
                      </div>
                      <div>
                        <a href="/tutorials/chat/#xss-protection">
                          <img src="/img/file.svg" /><span>XSS Protection<span>
                        </a>
                      </div>
                  </div>
                </section>
            </div>
          </aside>
        </div>
        <div class="seventy">
          <article>
            <div>
  <strong>
    <a class="button source" href="https://github.com/franciscop/tokyochat">Source code</a>
  </strong>
</div>


    <h1 id="real-time-chat">
      Real-time chat
    </h1>
  <p>In this tutorial you will learn how websockets work, the specifics of socket.io and how to create a real-time chat with server.js.</p>
<p>Make sure to <a href="/tutorials/getting-started/">follow the getting started tutorial</a> first. We won&#39;t use any database, so there is no chat history, just real time chat.</p>
<p>This tutorial is a beginner introduction. However, the socket.io plugin is experimental right now so please don&#39;t use this in production (or at least lock the version down). Also, there are absolutely no security measures now since this is a proof of concept.</p>

    <h2 id="user-interface">
      User Interface
    </h2>
  <p>First we are going to create a user interface that looks something like this:</p>
<p><img src="/tutorials/chat/img/mockup.png" alt="Tokyo Chat"></p>
<p>In your project folder create a folder <code>public</code> and put the file <code>index.html</code> inside:</p>
<pre><code class="language-html">&lt;!-- ./public/index.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;First website&lt;/title&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style.css&quot;&gt;
  &lt;/head&gt;
  &lt;body&gt;

    Hello world

    &lt;!-- Include jquery, cookies, socket.io (client-side) and your own code --&gt;
    &lt;script src=&quot;https://code.jquery.com/jquery-3.2.1.slim.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://unpkg.com/cookie_js@1.2.2/cookie.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://unpkg.com/socket.io-client@2/dist/socket.io.slim.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;javascript.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>This is the basic, fairly standard HTML skeleton of your chat. We are including few libraries that we will be using later on. Save it, open the file in your browser and you should see &quot;Hello World&quot;.</p>
<p>Now let&#39;s make the actual interface. We will wrap everything with a <code>&lt;main&gt;</code> tag for the general layout, then put the different elements inside. This code goes in the place of <code>Hello world</code> in the skeleton above:</p>
<pre><code class="language-html">&lt;main&gt;
  &lt;header&gt;
    &lt;div class=&quot;user-count&quot;&gt;0&lt;/div&gt;
    &lt;h1&gt;Tokyo Chat&lt;/h1&gt;
  &lt;/header&gt;

  &lt;section class=&quot;chat&quot;&gt;
    &lt;p&gt;&lt;strong&gt;Pepito&lt;/strong&gt;: Hey everyone!&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;親日&lt;/strong&gt;: こんいちは！&lt;/p&gt;
  &lt;/section&gt;

  &lt;form&gt;
    &lt;input type=&quot;text&quot; placeholder=&quot;Say something nice&quot; /&gt;
    &lt;button&gt;Send&lt;/button&gt;
  &lt;/form&gt;
&lt;/main&gt;</code></pre>
<p>The focus of this tutorial is <strong>not</strong> to teach HTML+CSS, so for now let&#39;s copy/paste the CSS into <code>./public/style.css</code>:</p>
<pre><code class="language-css">/* ./public/style.css */
* {
  box-sizing: border-box;
  transition: all .3s ease;
}

html, body {
  background: #eee;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

main {
  width: calc(100% - 20px);
  max-width: 500px;
  margin: 0 auto;
  font-family: Helvetica, Arial, Sans, sans-serif;
}

h1, .user-count {
  margin: 0;
  padding: 10px 0;
  font-size: 32px;
}

.user-count {
  float: right;
}

.chat {
  content: &#39;&#39;;
  width: 100%;
  height: calc(100vh - 165px);
  background: white;
  padding: 5px 10px;
}

.chat p {
  margin: 0 0 5px 0;
}

input, button {
  width: 100%;
  font: inherit;
  background: #fff;
  border: none;
  margin-top: 10px;
  padding: 5px 10px;
}

button:hover {
  cursor: pointer;
  background: #ddd;
}

@media all and (min-width: 500px) {
  .chat {
    height: calc(100vh - 140px);
  }
  input {
    width: calc(100% - 160px);
  }
  button {
    float: right;
    width: 150px;
  }
}</code></pre>
<p>You can see an example of this interface <a href="https://jsfiddle.net/franciscop/u9wepopc/">in this JSFiddle</a>. It is responsive and has many small details, so it should work smoothly on any (modern) device. It looks like this:</p>
<p><img src="/tutorials/chat/img/screenshot.png" alt="Screenshot of chat"></p>

    <h2 id="choose-a-username">
      Choose a username
    </h2>
  <p>Before doing anything else let&#39;s get the visitor username. Create a file called <code>javascript.js</code> inside the folder <code>public</code> with this:</p>
<pre><code class="language-js">// /public/javascript.js

// Get the current username from the cookies
var user = cookie.get(&#39;user&#39;);
if (!user) {

  // Ask for the username if there is none set already
  user = prompt(&#39;Choose a username:&#39;);
  if (!user) {
    alert(&#39;We cannot work with you like that!&#39;);
  } else {
    // Store it in the cookies for future use
    cookie.set(&#39;user&#39;, user);
  }
}</code></pre>
<p>It will try to retrieve the username from the cookies. If there is none, it will ask for the username with a standard system prompt like this:</p>
<p><img src="/tutorials/chat/img/screenshot_prompt.png" alt="Screenshot of chat with the prompt"></p>
<p>Now that we have the username stored in the cookies, let&#39;s see how to communicate with websockets.</p>

    <h2 id="sending-messages">
      Sending messages
    </h2>
  <p><a href="https://en.wikipedia.org/wiki/WebSocket">Websockets</a> is a web technology for real time, bidirectional communication from the browser to the server and back. This has traditionally been a hard problem, with the browser <a href="https://stackoverflow.com/a/28197906/938236">having to poke every X seconds</a> to the server to ask for new data.</p>
<p>The most commonly used library is <a href="https://socket.io/">socket.io</a> since it makes it a lot easier to use the underlying technology. We will use the client library (already included in our skeleton HTML code) for the browser. First, let&#39;s connect to the server:</p>
<pre><code class="language-js">// Connect to the server-side websockets. But there&#39;s no server yet!
var socket = io();</code></pre>
<p>Then we will be sending and receiving messages. Let&#39;s handle the receiving messages first with <code>socket.on(TYPE, callback)</code>:</p>
<pre><code class="language-js">// The user count. Can change when someone joins/leaves
socket.on(&#39;count&#39;, function (data) {
  $(&#39;.user-count&#39;).html(data);
});

// When we receive a message
// it will be like { user: &#39;username&#39;, message: &#39;text&#39; }
socket.on(&#39;message&#39;, function (data) {
  $(&#39;.chat&#39;).append(&#39;&lt;p&gt;&lt;strong&gt;&#39; + data.user + &#39;&lt;/strong&gt;: &#39; + data.message + &#39;&lt;/p&gt;&#39;);
});</code></pre>
<p>Finally, let&#39;s send some data when our form is submitted with <code>socket.emit()</code>:</p>
<pre><code class="language-js">// When the form is submitted
$(&#39;form&#39;).submit(function (e) {
  // Avoid submitting it through HTTP
  e.preventDefault();

  // Retrieve the message from the user
  var message = $(e.target).find(&#39;input&#39;).val();

  // Send the message to the server
  socket.emit(&#39;message&#39;, {
    user: cookie.get(&#39;user&#39;) || &#39;Anonymous&#39;,
    message: message
  });

  // Clear the input and focus it for a new message
  e.target.reset();
  $(e.target).find(&#39;input&#39;).focus();
});</code></pre>
<p>Awesome, if you have followed all along this is the final code for <code>javascript.js</code>:</p>
<pre><code class="language-js">// ./public/javascript.js

// Get the current username from the cookies
var user = cookie.get(&#39;user&#39;);
if (!user) {

  // Ask for the username if there is none set already
  user = prompt(&#39;Choose a username:&#39;);
  if (!user) {
    alert(&#39;We cannot work with you like that!&#39;);
  } else {
    // Store it in the cookies for future use
    cookie.set(&#39;user&#39;, user);
  }
}

var socket = io();

// The user count. Can change when someone joins/leaves
socket.on(&#39;count&#39;, function (data) {
  $(&#39;.user-count&#39;).html(data);
});

// When we receive a message
// it will be like { user: &#39;username&#39;, message: &#39;text&#39; }
socket.on(&#39;message&#39;, function (data) {
  $(&#39;.chat&#39;).append(&#39;&lt;p&gt;&lt;strong&gt;&#39; + data.user + &#39;&lt;/strong&gt;: &#39; + data.message + &#39;&lt;/p&gt;&#39;);
});

// When the form is submitted
$(&#39;form&#39;).submit(function (e) {
  // Avoid submitting it through HTTP
  e.preventDefault();

  // Retrieve the message from the user
  var message = $(e.target).find(&#39;input&#39;).val();

  // Send the message to the server
  socket.emit(&#39;message&#39;, {
    user: cookie.get(&#39;user&#39;) || &#39;Anonymous&#39;,
    message: message
  });

  // Clear the input and focus it for a new message
  e.target.reset();
  $(e.target).find(&#39;input&#39;).focus();
});
</code></pre>

    <h2 id="server-handling">
      Server handling
    </h2>
  <p>This library is included by default from <code>server</code>, so let&#39;s take advantage of it! First we create a simple server that will render our HTML page. Create a file in the root of your project called <code>index.js</code>:</p>
<pre><code class="language-js">// /index.js

const server = require(&#39;server&#39;);
const { get, socket } = server.router;
const { render } = server.reply;

server([
  get(&#39;/&#39;, ctx =&gt; render(&#39;index.html&#39;))
]);</code></pre>
<p>We can run in the terminal <code>node .</code> and access to <a href="http://localhost:3000/">localhost:3000</a> to see our chat interface.</p>
<p>Then we will add <code>connect</code> and <code>disconnect</code> routes. We want to update everyone with the current amount of users when someone joins or leaves. We can use the same function for both of them that will send a message to everyone with <a href="https://socket.io/docs/emit-cheatsheet/">socket.io&#39;s <code>io.emit()</code></a>:</p>
<pre><code class="language-js">// /index.js

const server = require(&#39;server&#39;);
const { get, socket } = server.router;
const { render } = server.reply;

const updateCounter = ctx =&gt; {
  ctx.io.emit(&#39;count&#39;, ctx.io.sockets.sockets.length);
};

server([
  // For the initial load render the index.html
  get(&#39;/&#39;, ctx =&gt; render(&#39;index.html&#39;)),

  // Join/leave the room
  socket(&#39;connect&#39;, updateCounter),
  socket(&#39;disconnect&#39;, updateCounter)
]);</code></pre>
<p>Finally let&#39;s create a new socket router that, when it receives a message, it will push the same message to everyone in a similar way as before:</p>
<pre><code class="language-js">// /index.js

const server = require(&#39;server&#39;);
const { get, socket } = server.router;
const { render } = server.reply;

// Update everyone with the current user count
const updateCounter = ctx =&gt; {
  ctx.io.emit(&#39;count&#39;, Object.keys(ctx.io.sockets.sockets).length);
};

// Send the new message to everyone
const sendMessage = ctx =&gt; {
  ctx.io.emit(&#39;message&#39;, ctx.data);
};

server([
  get(&#39;/&#39;, ctx =&gt; render(&#39;index.html&#39;)),
  socket(&#39;connect&#39;, updateCounter),
  socket(&#39;disconnect&#39;, updateCounter),
  socket(&#39;message&#39;, sendMessage)
]);</code></pre>
<p>Great, now we have our back-end. Launch it by running this in your terminal:</p>
<pre><code class="language-bash">node .</code></pre>
<p>Access <a href="http://localhost:3000/">localhost:3000</a> in two different tabs. You can now talk with yourself in realtime!</p>
<p><img src="/tutorials/chat/img/screenshot_final.png" alt="Final version"></p>

    <h2 id="user-x-joined">
      User X joined
    </h2>
  <p><strong>Exercise:</strong> add a new socket route and the corresponding back-end and front-end code to display a new message when a user writes their username.</p>
<p><strong>Tip:</strong> send an event called <code>join</code> from the front-end when a user writes their username with <code>socket.emit(&#39;join&#39;, ...)</code>.</p>
<p><strong>Tip 2:</strong> add a route in the back-end for this event that will emit the same to everyone.</p>
<p><strong>Tip 3:</strong> add a handler <code>socket.on(&#39;join&#39;, ...)</code> for this event in the front-end in a similar fashion to the <code>socket.on(&#39;message&#39;, ...)</code>.</p>

    <h2 id="upload-to-heroku">
      Upload to Heroku
    </h2>
  <p><strong>Exercise:</strong> upload our chat to Heroku so several people can use it.</p>
<p><strong>Tip:</strong> make sure to specify the engine in package.json, since we want for heroku to use Node.js 7.6.0 or newer.</p>

    <h2 id="xss-protection">
      XSS Protection
    </h2>
  <p><strong>Exercise:</strong> what happens when we write <code>&lt;script&gt;;alert(&#39;Hello world!&#39;);&lt;/script&gt;</code> as a message? Why is this dangerous? Please fix this issue.</p>
<p><strong>Extra:</strong> did you fix the visitor writing the same code in their username? Make sure this is also sanitized.</p>

          </article>
        </div>
      </div>
    </main>
    <script src="https://unpkg.com/prismjs@1.20.0/prism.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/umbrellajs" charset="utf-8"></script>
    <script src="/documentation/script.js" charset="utf-8"></script>
  </body>
</html>
